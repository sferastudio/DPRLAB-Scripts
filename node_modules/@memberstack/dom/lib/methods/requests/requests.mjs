var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));
var __async = (__this, __arguments, generator) => {
  return new Promise((resolve, reject) => {
    var fulfilled = (value) => {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    };
    var rejected = (value) => {
      try {
        step(generator.throw(value));
      } catch (e) {
        reject(e);
      }
    };
    var step = (x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected);
    step((generator = generator.apply(__this, __arguments)).next());
  });
};

// src/methods/requests/requests.ts
import axios from "axios";

// src/constants/endpoints.ts
var endpoints = {
  API: "https://client.memberstack.com"
};

// src/utils/cookies.ts
import Cookie from "js-cookie";
var memberAuthTokenName = "_ms-mid";
function isLocalStorageAvailable() {
  try {
    localStorage.setItem("test", "test");
    localStorage.removeItem("test");
    return true;
  } catch (e) {
    return false;
  }
}
var localStorageAvailable = isLocalStorageAvailable();
var getMemberToken = () => {
  if (localStorageAvailable) {
    const memAuthToken = localStorage.getItem(memberAuthTokenName);
    if (memAuthToken)
      return memAuthToken;
  }
  return Cookie.get(memberAuthTokenName);
};
var getSessionId = () => {
  if (typeof window === "undefined")
    return null;
  const sessionId = window.localStorage.getItem("ms_session_id");
  if (!sessionId || sessionId.length > 26) {
    window.localStorage.removeItem("ms_session_id");
    return null;
  }
  return sessionId;
};

// src/methods/requests/requests.ts
var HttpMethod = /* @__PURE__ */ ((HttpMethod2) => {
  HttpMethod2["POST"] = "POST";
  HttpMethod2["GET"] = "GET";
  HttpMethod2["PATCH"] = "PATCH";
  HttpMethod2["PUT"] = "PUT";
  HttpMethod2["DELETE"] = "DELETE";
  return HttpMethod2;
})(HttpMethod || {});
var HttpHeaders = /* @__PURE__ */ ((HttpHeaders2) => {
  HttpHeaders2["AUTHORIZATION"] = "Authorization";
  HttpHeaders2["API_KEY"] = "X-API-Key";
  HttpHeaders2["APP_ID"] = "X-APP-ID";
  HttpHeaders2["API_VERSION"] = "X-API-Version";
  HttpHeaders2["USER_AGENT"] = "X-User-Agent";
  HttpHeaders2["SESSION_ID"] = "X-Session-ID";
  return HttpHeaders2;
})(HttpHeaders || {});
var createRequestHandler = ({
  publicKey,
  appId,
  token,
  customEndpoint
}) => {
  return {
    sendRequest: (data, options) => __async(void 0, null, function* () {
      var _a, _b, _c, _d, _e, _f, _g, _h;
      try {
        const { url } = data;
        const memberToken = getMemberToken();
        const sessionToken = getSessionId();
        const authHeader = [
          (_b = (_a = data.headers) == null ? void 0 : _a["Authorization"]) == null ? void 0 : _b.replace("Bearer ", ""),
          memberToken,
          options == null ? void 0 : options.token
        ].find((x) => x);
        const formattedUrl = `${customEndpoint || endpoints.API}${url}`;
        const res = yield axios({
          method: data.method,
          data: data.data,
          url: formattedUrl,
          headers: __spreadProps(__spreadValues(__spreadValues(__spreadProps(__spreadValues(__spreadValues(__spreadValues({}, authHeader && { authorization: `Bearer ${authHeader}` }), publicKey && { ["X-API-Key" /* API_KEY */]: publicKey }), appId && { ["X-APP-ID" /* APP_ID */]: appId }), {
            ["X-User-Agent" /* USER_AGENT */]: "@memberstack/client@1.2.0"
          }), data.contentType && { "Content-Type": data.contentType }), sessionToken && {
            ["X-Session-ID" /* SESSION_ID */]: sessionToken
          }), {
            "referring-path": window.location.pathname
          }),
          withCredentials: true
        });
        if ((_c = res == null ? void 0 : res.headers) == null ? void 0 : _c["ms-mid"]) {
          token = res.headers["ms-mid"];
        }
        if ((_d = res == null ? void 0 : res.data) == null ? void 0 : _d.error) {
          if (res.data.error.name === "JsonWebTokenError") {
            throw {
              code: "client/invalid-token",
              message: "An invalid token has been provided. Please make sure the token is valid."
            };
          }
          throw (_e = res.data) == null ? void 0 : _e.error;
        }
        return res == null ? void 0 : res.data;
      } catch (e) {
        if (!e.response)
          throw e;
        throw ((_g = (_f = e.response) == null ? void 0 : _f.data) == null ? void 0 : _g.error) || ((_h = e.response) == null ? void 0 : _h.data);
      }
    }),
    sendRequestWithFetch: (data, options) => __async(void 0, null, function* () {
      var _a, _b;
      try {
        const { url, method, data: bodyData, headers, contentType } = data;
        const memberToken = getMemberToken();
        const authHeader = [
          (_a = headers == null ? void 0 : headers["Authorization"]) == null ? void 0 : _a.replace("Bearer ", ""),
          memberToken,
          options == null ? void 0 : options.token
        ].find((x) => x);
        const formattedUrl = `${customEndpoint || endpoints.API}${url}`;
        const fetchHeaders = __spreadProps(__spreadValues(__spreadValues(__spreadValues({}, authHeader && { Authorization: `Bearer ${authHeader}` }), publicKey && { ["X-API-Key" /* API_KEY */]: publicKey }), appId && { ["X-APP-ID" /* APP_ID */]: appId }), {
          ["X-User-Agent" /* USER_AGENT */]: "@memberstack/client@1.2.0",
          "Content-Type": "application/json",
          Referer: window.location.href
        });
        const response = yield fetch(formattedUrl, {
          method,
          headers: fetchHeaders,
          body: bodyData ? JSON.stringify(bodyData) : void 0,
          credentials: "include",
          keepalive: true
          // Keeps the connection open for further requests
        });
        const contentTypeHeader = response.headers.get("content-type");
        let result;
        if (contentTypeHeader == null ? void 0 : contentTypeHeader.includes("application/json")) {
          result = yield response.json();
        } else if (contentTypeHeader == null ? void 0 : contentTypeHeader.includes("text")) {
          result = yield response.text();
        } else if (response.status === 204) {
          result = null;
        } else {
          result = yield response.text();
        }
        if (response.headers.get("ms-mid")) {
          token = response.headers.get("ms-mid");
        }
        if (!response.ok) {
          if (((_b = result == null ? void 0 : result.error) == null ? void 0 : _b.name) === "JsonWebTokenError") {
            throw {
              code: "client/invalid-token",
              message: "An invalid token has been provided. Please make sure the token is valid."
            };
          }
          throw (result == null ? void 0 : result.error) || result;
        }
        return result;
      } catch (e) {
        console.error("Error in sendRequestWithFetch:", e);
        throw e;
      }
    })
  };
};
export {
  HttpHeaders,
  HttpMethod,
  createRequestHandler
};
